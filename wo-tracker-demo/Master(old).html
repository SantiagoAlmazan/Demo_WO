<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Master</title>
  <link rel="stylesheet" href="styles.css">

  
</head>
<body>
  <nav>
    <a href="index.html">Dashboard</a> |
    <a href="cnc.html">CNC</a> |
    <a href="molino.html">Molino</a> |
    <a href="ensamble.html">Ensamble</a> |
    <a href="lija.html">Lija</a> |
    <a href="pintura.html">Pintura</a>
  </nav>
<body data-page="master">
  <h1>Panel Master - Asignaci√≥n de Work Orders</h1>

  <!-- Bot√≥n para cargar el Excel -->
  <input type="file" id="excelFile" accept=".xlsx" />
  <button class="btn-guardar" onclick="cargarExcel()">Cargar Excel</button>
  <button class="btn-reporte" onclick="exportarReporte()">üì¶ Generar Reporte Diario</button>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Descripci√≥n</th>
        <th>Piezas</th>
        <th>Clasificaci√≥n</th>
        <th>Estado</th>
        <th>Historial</th>
        <th>Asignar estaci√≥n</th>
      </tr>
    </thead>
    <tbody id="tabla-master"></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="script.js"></script>

 <script>
  document.addEventListener("DOMContentLoaded", mostrarTablaMaster);

  let ultimoArchivo = null; // Guarda el √∫ltimo archivo Excel cargado

  async function cargarExcel() {
    const input = document.getElementById("excelFile");
    if (!input.files.length) return alert("Selecciona un archivo Excel primero");

    const file = input.files[0];
    ultimoArchivo = file; // Guardamos para futuras actualizaciones
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    localStorage.setItem("workOrders", JSON.stringify(rows));
    mostrarTablaMaster();
    console.log("‚úÖ Excel cargado correctamente");
  }

  function mostrarTablaMaster() {
    const tbody = document.getElementById("tabla-master");
    tbody.innerHTML = "";
    const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];

    allWOs.forEach((wo, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${wo.id}</td>
        <td>${wo.descripcion}</td>
        <td>${wo.piezas}</td>
        <td>${wo.clasificacion}</td>
        <td>${wo.estado || "Sin asignar"}</td>
        <td>${wo.historial || "-"}</td>
        <td>
          <select id="select-${i}" onchange="asignarEstacion(${i})">
            <option value="">Seleccionar</option>
            <option value="CNC">CNC</option>
            <option value="Molino">Molino</option>
            <option value="Ensamble">Ensamble</option>
            <option value="Lija">Lija</option>
            <option value="Pintura">Pintura</option>
            <option value="Finalizado">Finalizado</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function asignarEstacion(index) {
    const select = document.getElementById(`select-${index}`);
    const nueva = select.value;
    const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];

    if (!allWOs[index]) return;

    allWOs[index].estado = nueva;
    allWOs[index].historial = (allWOs[index].historial || "") + ` ‚Üí ${nueva} (${new Date().toLocaleString()})`;

    localStorage.setItem("workOrders", JSON.stringify(allWOs));
    mostrarTablaMaster();
  }

  function exportarReporte() {
    const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];
    const finalizadas = allWOs.filter(w => w.estado?.toLowerCase() === "finalizado");

    if (finalizadas.length === 0) return alert("No hay WOs finalizadas para reportar");

    const ws = XLSX.utils.json_to_sheet(finalizadas);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Reporte Diario");

    const fecha = new Date().toLocaleDateString().replace(/\//g, "-");
    XLSX.writeFile(wb, `Reporte_WOs_${fecha}.xlsx`);

    alert("üìä Reporte generado correctamente");
  }

  // üîÑ Bot√≥n manual para actualizar desde Excel
  function actualizarDesdeExcel() {
    if (!ultimoArchivo) {
      alert("Primero selecciona un archivo Excel con las WOs.");
      return;
    }
    console.log("üîÑ Actualizando datos desde Excel...");
    cargarExcel();
  }

  // ‚è±Ô∏è Actualizaci√≥n autom√°tica cada 30 segundos
  setInterval(() => {
    if (ultimoArchivo) {
      console.log("‚è±Ô∏è Actualizaci√≥n autom√°tica desde Excel...");
      cargarExcel();
    }
  }, 30000);
</script>

</body>
</html>
