<!DOCTYPE html>
<html lang="es">
<head>
<script> 

const SHEET_ID = "1cl_y6kFw3L8mEG8hz8iCPTv3LZ56ttdS9CatOFrhIho";
const RANGE = "Hoja 1!A:F";  // Columnas: id, descripcion, piezas, clasificacion, estado, historial
const CLIENT_ID = "311415667077-6ub4i7j6kln40lggd8e3aaldh04ec0k0.apps.googleusercontent.com"; // OAuth 2.0
const API_KEY = "AIzaSyC990sJS1msKWym_7rQdYwn47bTIDl1dRA";
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
const DISCOVERY_DOC = "https://sheets.googleapis.com/$discovery/rest?version=v4"; // üëà AGREGA ESTA L√çNEA

// Variables internas
let tokenClient;
let gapiIniciado = false;
let gisIniciado = false;

</script>
  <meta charset="UTF-8">
  <title>Panel Master - Google Sheets</title>
  <link rel="stylesheet" href="styles.css">

   <script>
  function iniciarGoogle() {
    console.log("üîπ Cargando cliente de Google API...");
    gapi.load("client", async () => {
      console.log("üî∏ gapi.client cargado, inicializando...");
      try {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        console.log("‚úÖ gapi.client inicializado correctamente");
        gapiIniciado = true;
        verificarInicio();
      } catch (err) {
        console.error("‚ùå Error al inicializar gapi:", err);
      }
    });
  }

  function iniciarTokenClient() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        console.log("‚úÖ Autenticaci√≥n exitosa:", tokenResponse);
      },
    });
    console.log("‚úÖ tokenClient inicializado correctamente");
    gisIniciado = true;
    verificarInicio();
  }

  function verificarInicio() {
    console.log("üîé Verificando inicio:", { gapiIniciado, gisIniciado });
    if (gapiIniciado && gisIniciado) {
      document.getElementById("btnAuth").disabled = false;
      console.log("‚úÖ Bot√≥n de autenticaci√≥n habilitado");
    }
  }
</script>



  <script src="https://apis.google.com/js/api.js"></script>
  <!-- Google API client -->
<script async defer src="https://apis.google.com/js/api.js" onload="iniciarGoogle()"></script>

<!-- Google Identity Services -->
<script async defer src="https://accounts.google.com/gsi/client" ></script>
<!-- ‚úÖ Solo una vez -->
<script async defer src="https://accounts.google.com/gsi/client" onload="iniciarTokenClient()"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="iniciarGoogle()"></script>

</head>
<body>
  <nav>

    <a href="index.html">Dashboard</a> |
    <a href="cnc.html">CNC</a> |
    <a href="molino.html">Molino</a> |
    <a href="ensamble.html">Ensamble</a> |
    <a href="lija.html">Lija</a> |
    <a href="pintura.html">Pintura</a>
    <a> Acerca de</a>

  </nav>

  <h1>Panel Master - Asignaci√≥n de Work Orders</h1>
<input type="text" id="buscador" placeholder="Buscar WO..." onkeyup="filtrarTabla()">

<script>
function filtrarTabla() {
  const filtro = document.getElementById("buscador").value.toLowerCase();
  const filas = document.querySelectorAll("table tbody tr");

  filas.forEach(fila => {
    const texto = fila.textContent.toLowerCase();
    fila.style.display = texto.includes(filtro) ? "" : "none";
  });
}
</script>

  <div class="acciones">
  <button id="btnAuth" disabled onclick="tokenClient.requestAccessToken()">üîê Conectar con Google</button>


  <button id="btnActualizar" onclick="cargarDatosDesdeSheets()" disabled>üîÑ Actualizar desde Sheets</button>
  <button onclick="exportarReporte()">üìä Exportar Reporte Diario</button>


  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Descripci√≥n</th>
        <th>Piezas</th>
        <th>Clasificaci√≥n</th>
        <th>Estacion asignada</th>
        <th>Historial</th>
        <th>Asignar estaci√≥n</th>
      </tr>
    </thead>
    <tbody id="tabla-master"></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
// ===============================================
// üîπ CONFIGURACI√ìN PRINCIPAL
// ===============================================


// ===============================================
// üîπ CARGA DE LIBRER√çAS DE GOOGLE
// ===============================================
function iniciarGoogle() {
  console.log("üîπ Cargando cliente de Google API...");

  gapi.load("client", async () => {
    console.log("üî∏ gapi.client cargado, inicializando...");
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    });
    gapiIniciado = true;
    console.log("‚úÖ gapi.client inicializado correctamente");
    verificarListo();
  });

    // Inicializa el token de autenticaci√≥n
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: "",
  });
  gisIniciado = true;
  console.log("‚úÖ tokenClient inicializado correctamente");

  verificarListo();
}

// ===============================================
// üîπ HABILITAR BOT√ìN DE CONEXI√ìN CUANDO TODO EST√Å LISTO
// ===============================================
function verificarListo() {
  if (gapiIniciado && gisIniciado) {
    document.getElementById("btnAuth").disabled = false;
  }
}

// ===============================================
// üîπ VERIFICAR CUANDO TODO EST√Å LISTO
// ===============================================
function verificarListo() {
  console.log("üîé Verificando inicio:", { gapiIniciado, gisIniciado });
  if (gapiIniciado && gisIniciado) {
    document.getElementById("btnAuth").disabled = false;
    console.log("‚úÖ Bot√≥n de autenticaci√≥n habilitado");
  }
}


// ===============================================
// üîπ AUTENTICACI√ìN CON GOOGLE
// ===============================================
function autenticarGoogle() {
  console.log("üü¢ Intentando autenticar con Google...");
  
  tokenClient.callback = async (resp) => {
    if (resp.error) throw resp;
    console.log("‚úÖ Autenticaci√≥n completada correctamente");
    
    document.getElementById("btnAuth").style.display = "none";
    document.getElementById("btnActualizar").disabled = false;

    await cargarDatosDesdeSheets();
  };

  if (gapi.client.getToken() === null) {
    console.log("üü° No hay token activo, solicitando acceso...");
    tokenClient.requestAccessToken({ prompt: "consent" });
  } else {
    console.log("üîÑ Token existente, renovando...");
    tokenClient.requestAccessToken({ prompt: "" });
  }
}
// ===============================================
// üîπ LEER DATOS DESDE GOOGLE SHEETS
// ===============================================
async function cargarDatosDesdeSheets() {
  try {
    const response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: RANGE,
    });

    const rows = response.result.values.slice(1); // omitir encabezados
    const workOrders = rows.map(r => ({
      id: r[0],
      descripcion: r[1],
      piezas: r[2],
      clasificacion: r[3],
      estado: r[4] || "Sin asignar",
      historial: r[5] || "-"
    }));

    localStorage.setItem("workOrders", JSON.stringify(workOrders));
    mostrarTablaMaster();
    console.log("‚úÖ Datos cargados desde Google Sheets");
  } catch (err) {
    console.error("‚ùå Error al leer Google Sheets:", err);
    alert("‚ö†Ô∏è No se pudo cargar la hoja. Revisa permisos o conexi√≥n.");
  }
}


// üîπ ACTUALIZAR UNA FILA EN GOOGLE SHEETS

async function actualizarEnSheets(index) {
  try {
    const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];
    const fila = index + 2; // +2 por el encabezado y base 1
    const wo = allWOs[index];

    const valores = [[
      wo.id, wo.descripcion, wo.piezas, wo.clasificacion, wo.estado, wo.historial
    ]];

    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SHEET_ID,
      range: `Hoja 1!A${fila}:F${fila}`,
      valueInputOption: "RAW",
      resource: { values: valores },
    });

    console.log(`‚úÖ Fila ${fila} actualizada en Google Sheets`);
  } catch (err) {
    console.error("‚ùå Error al actualizar en Sheets:", err);
  }
}

// üîπ ASIGNAR ESTACI√ìN Y GUARDAR CAMBIOS

function asignarEstacion(index) {
  const select = document.getElementById(`select-${index}`);
  const nueva = select.value;
  const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];

  if (!allWOs[index]) return;
  allWOs[index].estado = nueva;
  allWOs[index].estacion = nueva;
  allWOs[index].historial =
    (allWOs[index].historial || "") + ` ‚Üí ${nueva} (${new Date().toLocaleString()})`;

  localStorage.setItem("workOrders", JSON.stringify(allWOs));
  mostrarTablaMaster();

  // Actualiza la hoja remota
  actualizarEnSheets(index);
}

// üîπ MOSTRAR LA TABLA DE WOs

function mostrarTablaMaster() {
  const tbody = document.getElementById("tabla-master");
  tbody.innerHTML = "";
  const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];

  allWOs.forEach((wo, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${wo.id}</td>
      <td>${wo.descripcion}</td>
      <td>${wo.piezas}</td>
      <td>${wo.clasificacion}</td>
      <td>${wo.estado}</td>
      <td>${wo.historial}</td>
      <td>
        <select id="select-${i}" onchange="asignarEstacion(${i})">
          <option value="">Seleccionar</option>
          <option value="CNC">CNC</option>
          <option value="Molino">Molino</option>
          <option value="Ensamble">Ensamble</option>
          <option value="Lija">Lija</option>
          <option value="Pintura">Pintura</option>
          <option value="Finalizado">Finalizado</option>
        </select>
      </td>`;
      
    tbody.appendChild(tr);
  });
}
// üîπ EXPORTAR REPORTE DIARIO (TODOS LOS ESTADOS)
function exportarReporte() {
  // Obtener todas las √≥rdenes desde localStorage
  const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];

  if (allWOs.length === 0) {
    return alert("No hay WOs registradas para reportar");
  }

  // Convertir todas las WOs a hoja de Excel
  const ws = XLSX.utils.json_to_sheet(allWOs);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Reporte Diario");

  // Generar nombre de archivo con fecha
  const fecha = new Date().toLocaleDateString().replace(/\//g, "-");
  XLSX.writeFile(wb, `Reporte_WOs_${fecha}.xlsx`);

  alert("üìä Reporte generado correctamente");
}

// EXPORTAR REPORTE DIARIO
//function exportarReporte() {
 //const allWOs = JSON.parse(localStorage.getItem("workOrders")) || [];
  //const finalizadas = allWOs.filter(w => w.estado?.toLowerCase() === "finalizado");


  //const ws = XLSX.utils.json_to_sheet(finalizadas);
  //const wb = XLSX.utils.book_new();
  //XLSX.utils.book_append_sheet(wb, ws, "Reporte Diario");

  //const fecha = new Date().toLocaleDateString().replace(/\//g, "-");
  //XLSX.writeFile(wb, `Reporte_WOs_${fecha}.xlsx`);

  //alert("üìä Reporte generado correctamente");
//}


// üîπ MONITOREO AUTOM√ÅTICO DESDE GOOGLE SHEETS
let ultimaVersion = ""; // para comparar cambios

async function monitorearCambios() {
  try {
    // Leer hoja actual
    const response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: RANGE,
    });

    const nuevaVersion = JSON.stringify(response.result.values); // snapshot de datos

    // Si hay diferencia con la √∫ltima versi√≥n, recargar datos
    if (nuevaVersion !== ultimaVersion) {
      ultimaVersion = nuevaVersion;

      const rows = response.result.values.slice(1);
      const workOrders = rows.map(r => ({
        id: r[0],
        descripcion: r[1],
        piezas: r[2],
        clasificacion: r[3],
        estado: r[4] || "Sin asignar",
        historial: r[5] || "-"
      }));

      localStorage.setItem("workOrders", JSON.stringify(workOrders));
      mostrarTablaMaster();

      console.log("üîÑ Datos actualizados autom√°ticamente desde Sheets");
    }
  } catch (err) {
    console.warn("‚ö†Ô∏è No se pudo actualizar autom√°ticamente:", err.message);
  }
}

// Inicia el monitoreo cada 10 segundos
setInterval(() => {
  if (gapi.client.getToken()) {
    monitorearCambios();
  }
}, 10000);



</script>

<!-- üîπ Librer√≠as externas necesarias -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Librer√≠as de Google -->
<script src="https://apis.google.com/js/api.js" onload="iniciarGoogle()"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>


</body>
</html>
